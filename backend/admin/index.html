<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>üåπ RedVelvetLive ¬∑ Panel Administrativo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115;--panel:#151822;--soft:#191c27;--text:#e9ecf1;
      --muted:#9aa3b2;--brand:#e31221;--ok:#16a34a;--warn:#f59e0b;
      --err:#ef4444;--br:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial;
      color:var(--text);
      background:linear-gradient(180deg,#0b0c10,#10131a);
      min-height:100vh;display:flex;align-items:center;justify-content:center}
    .card{background:var(--panel);border:1px solid #232633;border-radius:var(--br);
      box-shadow:0 10px 24px rgba(0,0,0,.25);padding:24px;width:100%;max-width:1100px;margin:20px}
    h1{font-size:24px;margin:0 0 12px}
    h2{font-size:18px;margin:0 0 8px}
    input,button,select{border-radius:10px;border:1px solid #2a2e3b;background:#0e1118;
      color:var(--text);padding:10px 12px;font-size:14px}
    button{background:var(--brand);border-color:var(--brand);font-weight:700;cursor:pointer}
    button.secondary{background:#1f2431;border-color:#2a2e3b}
    button:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    table{width:100%;border-collapse:collapse;font-size:13px;margin-top:10px}
    th,td{padding:8px 10px;border-bottom:1px solid #202433;text-align:left}
    th{color:#c3c9d4;background:var(--soft);position:sticky;top:0}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px}
    .b-ok{background:#0f2b18;color:#6df0a7;border:1px solid #1a6a43}
    .b-warn{background:#2b230f;color:#ffd27a;border:1px solid #6a531a}
    .b-err{background:#2b1111;color:#ff9aaa;border:1px solid #6a1a1a}
    .b-pending{background:#1a2030;color:#9ab8ff;border:1px solid #334a85}
    .hr{height:1px;background:#212436;margin:14px 0}
    .muted{color:var(--muted)}
    .right{text-align:right}
    #toast{position:fixed;bottom:-100px;right:20px;transition:.4s;opacity:0;
      background:#2563eb;color:#fff;font-weight:700;padding:10px 14px;border-radius:10px;
      box-shadow:0 10px 20px rgba(0,0,0,.4)}
    #toast.show{bottom:20px;opacity:1}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <div id="loginView" class="card">
    <h1>üîê Ingreso Administrativo</h1>
    <p class="muted">Accede al panel seguro de RedVelvetLive</p>
    <div class="row">
      <input id="email" type="email" placeholder="Correo (ADMIN_EMAIL)" style="flex:1" />
      <input id="key" type="password" placeholder="Clave (ADMIN_SECRET_KEY)" style="flex:1" />
      <button id="loginBtn">Ingresar</button>
    </div>
  </div>

  <div id="panelView" class="card hidden">
    <h1>üåπ RedVelvetLive ‚Äî Panel Administrativo</h1>
    <div class="row right">
      <button id="logoutBtn" class="secondary">Cerrar sesi√≥n</button>
    </div>
    <div class="hr"></div>

    <div class="row">
      <button id="runCron">‚ñ∂ Ejecutar Cron</button>
      <input id="txHash" type="text" placeholder="0x... Hash transacci√≥n" style="flex:1" />
      <button id="auditBtn">Auditar</button>
      <button id="refreshBtn">üîÑ Cargar √ìrdenes</button>
    </div>

    <table id="ordersTable">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Modelo</th>
          <th>Monto</th>
          <th>Moneda</th>
          <th>Tipo</th>
          <th>Estado</th>
          <th>Tx</th>
        </tr>
      </thead>
      <tbody id="ordersBody">
        <tr><td colspan="7" class="muted">Sin datos‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>

  <div id="toast"></div>

  <script>
    const API = location.origin.includes("localhost")
      ? "http://localhost:4000/api"
      : location.origin + "/api";
    const $ = (s)=>document.querySelector(s);
    const toast=(m,t="info")=>{
      const el=$("#toast");
      el.textContent=m;
      el.style.background=t==="ok"?"#16a34a":t==="err"?"#ef4444":"#2563eb";
      el.classList.add("show");
      setTimeout(()=>el.classList.remove("show"),2500);
    };

    const loginView=$("#loginView"),panelView=$("#panelView");

    async function verifySession(){
      try{
        const res=await fetch(API+"/admin/verify",{credentials:"include"});
        const data=await res.json();
        if(data.success){
          loginView.classList.add("hidden");
          panelView.classList.remove("hidden");
          loadOrders();
        }
      }catch{}
    }

    $("#loginBtn").onclick=async()=>{
      const email=$("#email").value.trim();
      const key=$("#key").value.trim();
      if(!email||!key)return toast("Campos incompletos","err");
      try{
        const res=await fetch(API+"/admin/login",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({email,key}),
          credentials:"include"
        });
        const data=await res.json();
        if(data.success){
          toast("Bienvenido "+data.admin.email,"ok");
          loginView.classList.add("hidden");
          panelView.classList.remove("hidden");
          loadOrders();
        }else toast(data.message||"Acceso denegado","err");
      }catch{toast("Error de conexi√≥n","err")}
    };

    $("#logoutBtn").onclick=async()=>{
      await fetch(API+"/admin/logout",{method:"POST",credentials:"include"});
      panelView.classList.add("hidden");
      loginView.classList.remove("hidden");
      toast("Sesi√≥n cerrada","ok");
    };

    // ======= Funciones administrativas =======
    $("#runCron").onclick=async()=>{
      try{
        const res=await fetch(API+"/admin/payments/cron/run",{
          method:"POST",credentials:"include"
        });
        const data=await res.json();
        if(data.success)toast("Cron ejecutado","ok");else toast("Error al ejecutar","err");
      }catch{toast("Error","err")}
    };

    $("#auditBtn").onclick=async()=>{
      const tx=$("#txHash").value.trim();
      if(!tx)return toast("Ingresa hash","err");
      try{
        const res=await fetch(API+"/admin/payments/audit/"+tx,{credentials:"include"});
        const data=await res.json();
        if(data.success)toast("Tx verificada ‚úÖ","ok");
        else toast("No verificada","warn");
      }catch{toast("Error auditando","err")}
    };

    async function loadOrders(){
      const tbody=$("#ordersBody");
      tbody.innerHTML="<tr><td colspan='7' class='muted'>Cargando‚Ä¶</td></tr>";
      try{
        const res=await fetch(API+"/admin/payments/orders",{credentials:"include"});
        const data=await res.json();
        if(!data.success)return toast("Error obteniendo √≥rdenes","err");
        tbody.innerHTML="";
        data.data.forEach(o=>{
          const s=(o.status||"").toUpperCase();
          const map={PENDING:"b-pending",PROCESSING:"b-warn",CONFIRMED:"b-ok",FAILED:"b-err",CANCELLED:"b-err"};
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${new Date(o.createdAt).toLocaleString()}</td>
            <td>${o.modelId?.name||"‚Äî"}</td>
            <td><b>${o.amount}</b></td>
            <td>${o.currency}</td>
            <td>${o.type}</td>
            <td><span class="badge ${map[s]||"b-pending"}">${s}</span></td>
            <td>${o.txHash?`<a href='https://bscscan.com/tx/${o.txHash}' target='_blank'>${o.txHash.slice(0,10)}‚Ä¶</a>`:"‚Äî"}</td>`;
          tbody.appendChild(tr);
        });
      }catch{toast("Error cargando √≥rdenes","err")}
    }

    verifySession();
  </script>
</body>
</html>

