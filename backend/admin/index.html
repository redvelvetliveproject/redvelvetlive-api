<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>üåπ RedVelvetLive ¬∑ Panel Administrativo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115;--panel:#151822;--soft:#191c27;--text:#e9ecf1;
      --muted:#9aa3b2;--brand:#e31221;--ok:#16a34a;--warn:#f59e0b;
      --err:#ef4444;--br:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial;
      color:var(--text);background:linear-gradient(180deg,#0b0c10,#10131a);
      min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:30px}
    .card{background:var(--panel);border:1px solid #232633;border-radius:var(--br);
      box-shadow:0 10px 24px rgba(0,0,0,.25);padding:24px;width:100%;max-width:1200px;margin:10px auto}
    h1{font-size:24px;margin:0 0 12px}
    h2{font-size:18px;margin:0 0 8px}
    input,button,select{border-radius:10px;border:1px solid #2a2e3b;background:#0e1118;
      color:var(--text);padding:10px 12px;font-size:14px}
    button{background:var(--brand);border-color:var(--brand);font-weight:700;cursor:pointer;transition:.2s}
    button:hover{opacity:.85}
    button.secondary{background:#1f2431;border-color:#2a2e3b}
    button:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    table{width:100%;border-collapse:collapse;font-size:13px;margin-top:10px}
    th,td{padding:8px 10px;border-bottom:1px solid #202433;text-align:left}
    th{color:#c3c9d4;background:var(--soft);position:sticky;top:0;z-index:2}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px}
    .b-ok{background:#0f2b18;color:#6df0a7;border:1px solid #1a6a43}
    .b-warn{background:#2b230f;color:#ffd27a;border:1px solid #6a531a}
    .b-err{background:#2b1111;color:#ff9aaa;border:1px solid #6a1a1a}
    .b-pending{background:#1a2030;color:#9ab8ff;border:1px solid #334a85}
    .hr{height:1px;background:#212436;margin:14px 0}
    .muted{color:var(--muted)}
    .hidden{display:none!important}
    .tabs{display:flex;gap:6px;margin-bottom:14px}
    .tab{flex:1;text-align:center;padding:10px;border-radius:8px;cursor:pointer;
         background:#1a1d25;border:1px solid #2a2e3b;font-weight:600}
    .tab.active{background:var(--brand);border-color:var(--brand)}
    #toast{position:fixed;bottom:-100px;right:20px;transition:.4s;opacity:0;
      background:#2563eb;color:#fff;font-weight:700;padding:10px 14px;border-radius:10px;
      box-shadow:0 10px 20px rgba(0,0,0,.4);z-index:999}
    #toast.show{bottom:20px;opacity:1}
  </style>
</head>
<body>

  <!-- üîê LOGIN -->
  <div id="loginView" class="card">
    <h1>üîê Ingreso Administrativo</h1>
    <p class="muted">Accede al panel seguro de RedVelvetLive</p>
    <div class="row">
      <input id="email" type="email" placeholder="Correo (ADMIN_EMAIL)" style="flex:1" />
      <input id="key" type="password" placeholder="Clave (ADMIN_SECRET_KEY)" style="flex:1" />
      <button id="loginBtn">Ingresar</button>
    </div>
  </div>

  <!-- üåπ PANEL -->
  <div id="panelView" class="card hidden">
    <h1>üåπ RedVelvetLive ‚Äî Panel Administrativo</h1>
    <div class="row" style="justify-content:flex-end">
      <button id="logoutBtn" class="secondary">Cerrar sesi√≥n</button>
    </div>

    <div class="hr"></div>

    <!-- üìë TABS -->
    <div class="tabs">
      <div class="tab active" data-tab="pagos">üí∞ Pagos</div>
      <div class="tab" data-tab="modelos">üë©‚Äçüíº Modelos</div>
    </div>

    <!-- üí∞ TAB PAGOS -->
    <div id="tab-pagos">
      <div class="row">
        <button id="runCron">‚ñ∂ Ejecutar Cron</button>
        <input id="txHash" type="text" placeholder="0x... Hash transacci√≥n" style="flex:1" />
        <button id="auditBtn">Auditar</button>
        <button id="refreshBtn">üîÑ Cargar √ìrdenes</button>
      </div>

      <table id="ordersTable">
        <thead>
          <tr>
            <th>Fecha</th><th>Modelo</th><th>Monto</th><th>Moneda</th>
            <th>Tipo</th><th>Estado</th><th>Tx</th>
          </tr>
        </thead>
        <tbody id="ordersBody">
          <tr><td colspan="7" class="muted">Sin datos‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>

    <!-- üë©‚Äçüíº TAB MODELOS -->
    <div id="tab-modelos" class="hidden">
      <div class="row">
        <input id="searchModel" placeholder="Buscar nombre / pa√≠s / wallet" style="flex:2">
        <select id="filterStatus">
          <option value="">Estado (todos)</option>
          <option value="ACTIVE">ACTIVE</option>
          <option value="INACTIVE">INACTIVE</option>
          <option value="BANNED">BANNED</option>
        </select>
        <button id="loadModelsBtn">üîÑ Cargar Modelos</button>
      </div>

      <table id="modelsTable">
        <thead>
          <tr>
            <th>Nombre</th><th>Pa√≠s</th><th>Wallet</th><th>Estado</th>
            <th>‚≠ê Destacada</th><th>üíé Embajadora</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody id="modelsBody">
          <tr><td colspan="7" class="muted">Sin datos‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    const API = location.origin.includes("localhost") ? "http://localhost:4000/api" : location.origin + "/api";
    const $ = (s)=>document.querySelector(s);
    const toast=(m,t="info")=>{
      const el=$("#toast");
      el.textContent=m;
      el.style.background=t==="ok"?"#16a34a":t==="err"?"#ef4444":"#2563eb";
      el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),2500);
    };

    const loginView=$("#loginView"), panelView=$("#panelView");

    async function verifySession(){
      try{
        const res=await fetch(API+"/admin/verify",{credentials:"include"});
        const data=await res.json();
        if(data.success){ showPanel(); }
      }catch{}
    }

    function showPanel(){
      loginView.classList.add("hidden");
      panelView.classList.remove("hidden");
      loadOrders();
    }

    $("#loginBtn").onclick=async()=>{
      const email=$("#email").value.trim(), key=$("#key").value.trim();
      if(!email||!key)return toast("Campos incompletos","err");
      try{
        const res=await fetch(API+"/admin/login",{
          method:"POST",headers:{"Content-Type":"application/json"},
          body:JSON.stringify({email,key}),credentials:"include"
        });
        const data=await res.json();
        if(data.success){ toast("Bienvenido "+data.admin.email,"ok"); showPanel(); }
        else toast(data.message||"Acceso denegado","err");
      }catch{toast("Error de conexi√≥n","err")}
    };

    $("#logoutBtn").onclick=async()=>{
      await fetch(API+"/admin/logout",{method:"POST",credentials:"include"});
      panelView.classList.add("hidden"); loginView.classList.remove("hidden");
      toast("Sesi√≥n cerrada","ok");
    };

    // ======= üìë TABS =======
    document.querySelectorAll(".tab").forEach(tab=>{
      tab.onclick=()=>{
        document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
        tab.classList.add("active");
        const name=tab.dataset.tab;
        $("#tab-pagos").classList.toggle("hidden", name!=="pagos");
        $("#tab-modelos").classList.toggle("hidden", name!=="modelos");
        if(name==="modelos")loadModels();
      };
    });

    // ======= üí∞ PAGOS =======
    $("#runCron").onclick=async()=>{
      try{
        const r=await fetch(API+"/admin/payments/cron/run",{method:"POST",credentials:"include"});
        const d=await r.json();
        d.success?toast("Cron ejecutado","ok"):toast("Error al ejecutar","err");
      }catch{toast("Error","err")}
    };

    $("#auditBtn").onclick=async()=>{
      const tx=$("#txHash").value.trim(); if(!tx)return toast("Ingresa hash","err");
      try{
        const r=await fetch(API+"/admin/payments/audit/"+tx,{credentials:"include"});
        const d=await r.json();
        d.verified?toast("Tx verificada ‚úÖ","ok"):toast("No verificada","warn");
      }catch{toast("Error auditando","err")}
    };

    async function loadOrders(){
      const tbody=$("#ordersBody"); tbody.innerHTML="<tr><td colspan='7' class='muted'>Cargando‚Ä¶</td></tr>";
      try{
        const r=await fetch(API+"/admin/payments/orders",{credentials:"include"});
        const d=await r.json(); if(!d.success)return toast("Error obteniendo √≥rdenes","err");
        tbody.innerHTML="";
        d.data.forEach(o=>{
          const s=(o.status||"").toUpperCase();
          const map={PENDING:"b-pending",PROCESSING:"b-warn",CONFIRMED:"b-ok",FAILED:"b-err",CANCELLED:"b-err"};
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${new Date(o.createdAt).toLocaleString()}</td>
            <td>${o.modelId?.name||"‚Äî"}</td>
            <td><b>${o.amount}</b></td>
            <td>${o.currency}</td>
            <td>${o.type}</td>
            <td><span class="badge ${map[s]||"b-pending"}">${s}</span></td>
            <td>${o.txHash?`<a href='https://bscscan.com/tx/${o.txHash}' target='_blank'>${o.txHash.slice(0,10)}‚Ä¶</a>`:"‚Äî"}</td>`;
          tbody.appendChild(tr);
        });
      }catch{toast("Error cargando √≥rdenes","err")}
    }

    // ======= üë©‚Äçüíº MODELOS =======
    async function loadModels(){
      const tbody=$("#modelsBody");
      tbody.innerHTML="<tr><td colspan='7' class='muted'>Cargando‚Ä¶</td></tr>";
      const status=$("#filterStatus").value, search=$("#searchModel").value.trim();
      const qs=new URLSearchParams(); if(status)qs.set("status",status); if(search)qs.set("search",search);
      try{
        const r=await fetch(API+"/admin/models?"+qs.toString(),{credentials:"include"});
        const d=await r.json(); if(!d.success)return toast("Error obteniendo modelos","err");
        tbody.innerHTML="";
        d.data.forEach(m=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${m.name||"‚Äî"}</td>
            <td>${m.country||"‚Äî"}</td>
            <td><code>${m.wallet?.slice(0,10)||"‚Äî"}</code></td>
            <td><b>${m.status}</b></td>
            <td><input type='checkbox' ${m.featured?"checked":""} data-id='${m._id}' data-field='featured'></td>
            <td><input type='checkbox' ${m.ambassador?"checked":""} data-id='${m._id}' data-field='ambassador'></td>
            <td>
              <select data-id='${m._id}' data-action='status'>
                <option ${m.status==="ACTIVE"?"selected":""}>ACTIVE</option>
                <option ${m.status==="INACTIVE"?"selected":""}>INACTIVE</option>
                <option ${m.status==="BANNED"?"selected":""}>BANNED</option>
              </select>
            </td>`;
          tbody.appendChild(tr);
        });

        // Cambios r√°pidos
        tbody.onchange=async(e)=>{
          const el=e.target;
          const id=el.dataset.id;
          if(el.dataset.field){
            const field=el.dataset.field;
            const body={ [field]: el.checked };
            await fetch(API+"/admin/models/"+id+"/feature",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(body),credentials:"include"});
            toast("Modelo actualizado","ok");
          }
          if(el.dataset.action==="status"){
            const val=el.value;
            await fetch(API+"/admin/models/"+id+"/status",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:val}),credentials:"include"});
            toast("Estado actualizado","ok");
          }
        };
      }catch{toast("Error cargando modelos","err")}
    }

    $("#loadModelsBtn").onclick=loadModels;
    verifySession();
  </script>
</body>
</html>


